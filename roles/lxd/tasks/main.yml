---
- name: Ensure snapd is installed
  package:
    name: snapd
    state: present


- name: Ensure system-packaged LXD is removed
  apt:
    name: [lxd, lxd-client]
    state: absent
    autoremove: true

- name: Check whether LXD snap is already installed
  # TODO: Replace with snap module once available
  command: "snap list"
  register: installed_snaps
  changed_when: false

- name: Install LXD snap
  command: "snap install lxd"
  when: "'lxd' not in installed_snaps.stdout"
  register: lxd_installation

- name: Reboot if the snap was installed
  shell: "sleep 5 && reboot"
  args:
    warn: false
  async: 1
  poll: 0
  when: lxd_installation is changed

- name: Wait for the reboot to complete if the snap was installed
  wait_for_connection:
    connect_timeout: 20
    sleep: 5
    delay: 5
    timeout: 600
  when: lxd_installation is changed

- name: Set up a network bridge
  include_role:
    name: bridge
  when: setup_bridge



- name: Copy bridged LXD configuration
  copy:
    src: files/lxd-bridge-preseed.yml
    dest: /etc/lxd-bridge-preseed.yml
  when: setup_bridge is defined and setup_bridge

- name: Initialize bridged LXD
  shell: lxd init --preseed < /etc/lxd-bridge-preseed.yml && rm -f /etc/ansible-lxd-init && touch /etc/ansible-lxd-bridge-init creates=/etc/ansible-lxd-bridge-init
  args:
    warn: false
# Don't forget to mark bridged LXD as initialized and nonbridget as not!
# Run auto init when no bridge is desired
- name: Initialize LXD
  args:
    warn: false
  shell: lxd init --auto && touch /etc/ansible-lxd-init && rm -f /etc/ansible-lxd-bridge-init creates=/etc/ansible-lxd-init
  when: setup_bridge is not defined or not setup_bridge
